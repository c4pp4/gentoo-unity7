From 5f5ec2e81c7f0e016aee0dc074aeb149c5430193 Mon Sep 17 00:00:00 2001
From: c4pp4
Date: Fri, 23 Jan 2026 04:02:43 +0100
Subject: [PATCH 1/1] Fix panel transparency

Signed-off-by: c4pp4
---
 panel/PanelView.cpp                   |  7 ++-----
 plugins/unityshell/src/unityshell.cpp | 30 ---------------------------
 2 files changed, 2 insertions(+), 35 deletions(-)

diff --git a/panel/PanelView.cpp b/panel/PanelView.cpp
index 1a54ab1..cffa311 100644
--- a/panel/PanelView.cpp
+++ b/panel/PanelView.cpp
@@ -186,16 +186,12 @@ void PanelView::EnableOverlayMode(bool overlay_mode)
 {
   if (overlay_mode)
   {
-    bg_effect_helper_.enabled = true;
     indicators_->OverlayShown();
     menu_view_->OverlayShown();
     SetAcceptKeyNavFocusOnMouseDown(false);
   }
   else
   {
-    if (opacity_ >= 1.0f)
-      bg_effect_helper_.enabled = false;
-
     menu_view_->OverlayHidden();
     indicators_->OverlayHidden();
     SetAcceptKeyNavFocusOnMouseDown(true);
@@ -532,6 +528,8 @@ PanelView::UpdateBackground()
   WindowManager& wm = WindowManager::Default();
   is_dirty_ = false;
 
+  bg_effect_helper_.enabled = IsTransparent();
+
   nux::ROPConfig rop;
   rop.Blend = true;
   rop.SrcBlend = GL_ONE;
@@ -691,7 +689,6 @@ void PanelView::SetOpacity(float opacity)
     return;
 
   opacity_ = (opacity <= 0.0f ? 0.0001f : opacity); // Not to get a black menu area
-  bg_effect_helper_.enabled = IsTransparent();
 
   ForceUpdateBackground();
 }
diff --git a/plugins/unityshell/src/unityshell.cpp b/plugins/unityshell/src/unityshell.cpp
index 38f433a..d33fb6a 100644
--- a/plugins/unityshell/src/unityshell.cpp
+++ b/plugins/unityshell/src/unityshell.cpp
@@ -892,8 +892,6 @@ void UnityScreen::paintOutput()
 {
   CompOutput *output = last_output_;
 
-  DrawPanelUnderDash();
-
   /* Bind the currently bound draw framebuffer to the read framebuffer binding.
    * The reason being that we want to use the results of nux images being
    * drawn to this framebuffer in glCopyTexSubImage2D operations */
@@ -1010,34 +1008,6 @@ void UnityScreen::paintOutput()
   didShellRepaint = true;
 }
 
-void UnityScreen::DrawPanelUnderDash()
-{
-  if (!paint_panel_under_dash_ || (!dash_controller_->IsVisible() && !hud_controller_->IsVisible()))
-    return;
-
-  auto const& output_dev = screen->currentOutputDev();
-
-  if (last_output_->id() != output_dev.id())
-    return;
-
-  auto graphics_engine = nux::GetGraphicsDisplay()->GetGraphicsEngine();
-
-  if (!graphics_engine->UsingGLSLCodePath())
-    return;
-
-  graphics_engine->ResetModelViewMatrixStack();
-  graphics_engine->Push2DTranslationModelViewMatrix(0.0f, 0.0f, 0.0f);
-  graphics_engine->ResetProjectionMatrix();
-  graphics_engine->SetOrthographicProjectionMatrix(output_dev.width(), output_dev.height());
-
-  nux::TexCoordXForm texxform;
-  texxform.SetWrap(nux::TEXWRAP_REPEAT, nux::TEXWRAP_CLAMP);
-
-  int monitor = WM.MonitorGeometryIn(NuxGeometryFromCompRect(output_dev));
-  auto const& texture = panel_style_.GetBackground(monitor)->GetDeviceTexture();
-  graphics_engine->QRP_GLSL_1Tex(0, 0, output_dev.width(), texture->GetHeight(), texture, texxform, nux::color::White);
-}
-
 bool UnityScreen::forcePaintOnTop()
 {
   if (!allowWindowPaint ||
-- 
2.52.0

