From b22feb1cbc28d6b02e7e892be93bfff16a3c53cf Mon Sep 17 00:00:00 2001
From: c4pp4
Date: Thu, 30 Sep 2021 21:19:16 +0200
Subject: [PATCH 1/1] Use unity-control-center as the fallback

Try to use unity-control-center as the fallback when gnome-control-center
is not available.

Signed-off-by: c4pp4
---
 src/contacts-app.vala |  8 ++++++++
 src/meson.build       |  1 +
 src/xdg-desktop.vala  | 22 ++++++++++++++++++++++
 3 files changed, 31 insertions(+)
 create mode 100644 src/xdg-desktop.vala

diff --git a/src/contacts-app.vala b/src/contacts-app.vala
index b1adaf4..77d3952 100644
--- a/src/contacts-app.vala
+++ b/src/contacts-app.vala
@@ -143,8 +143,16 @@ public class Contacts.App : Gtk.Application {
 
       proxy.call_sync ("Activate", param, DBusCallFlags.NONE, -1);
     } catch (Error e) {
+      if (is_desktop ("Unity")) {
+        try {
+          Process.spawn_command_line_async ("unity-control-center online-accounts");
+        } catch (SpawnError ex) {
+          warning ("Couldn't open Unity Control Center: %s", ex.message);
+        }
+      } else {
       // TODO: Show error dialog
       warning ("Couldn't open online-accounts: %s", e.message);
+      }
     }
   }
 
diff --git a/src/meson.build b/src/meson.build
index d977638..08e5d31 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -96,6 +96,7 @@ contacts_vala_sources = files(
   'contacts-type-combo.vala',
   'contacts-ui-state.vala',
   'main.vala',
+  'xdg-desktop.vala',
 )
 
 contacts_c_sources = [
diff --git a/src/xdg-desktop.vala b/src/xdg-desktop.vala
new file mode 100644
index 0000000..cbcbbed
--- /dev/null
+++ b/src/xdg-desktop.vala
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2014 Robert Ancell.
+ *
+ * This program is free software: you can redistribute it and/or modify it under
+ * the terms of the GNU General Public License as published by the Free Software
+ * Foundation, either version 2 of the License, or (at your option) any later
+ * version. See http://www.gnu.org/copyleft/gpl.html the full text of the
+ * license.
+ */
+
+private bool is_desktop (string name)
+{
+    var desktop_name_list = Environment.get_variable ("XDG_CURRENT_DESKTOP");
+    if (desktop_name_list == null)
+        return false;
+
+    foreach (var n in desktop_name_list.split (":"))
+        if (n == name)
+            return true;
+
+    return false;
+}
-- 
2.32.0

