From 14ed3602ea177ad285784c5d04d0d094ce657d6c Mon Sep 17 00:00:00 2001
From: c4pp4
Date: Mon, 11 Aug 2025 02:59:49 +0200
Subject: [PATCH 1/1] Disable global menu, use GTK3 and libappindicator

https://github.com/transmission/transmission/issues/5332

Signed-off-by: c4pp4
---
 CMakeLists.txt                  | 1 +
 cmake/FindAPPINDICATOR.cmake    | 2 +-
 gtk/transmission-gtk.desktop.in | 6 +++---
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index d70078b..b31e42d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -311,6 +311,7 @@ endif()
 if(ENABLE_GTK)
     tr_get_required_flag(ENABLE_GTK GTK_IS_REQUIRED)
 
+    set(USE_GTK_VERSION 3)
     if(USE_GTK_VERSION STREQUAL "AUTO" OR USE_GTK_VERSION EQUAL 4)
         pkg_check_modules(GTK4
             gtkmm-4.0>=${GTKMM_MINIMUM}
diff --git a/cmake/FindAPPINDICATOR.cmake b/cmake/FindAPPINDICATOR.cmake
index c398b13..94f6758 100644
--- a/cmake/FindAPPINDICATOR.cmake
+++ b/cmake/FindAPPINDICATOR.cmake
@@ -10,7 +10,7 @@ find_library(AYATANA_APPINDICATOR_LIBRARY
         ayatana-appindicator
     HINTS ${PC_AYATANA_APPINDICATOR_LIBRARY_DIRS})
 
-if(AYATANA_APPINDICATOR_INCLUDE_DIR AND AYATANA_APPINDICATOR_LIBRARY)
+if(NOT (AYATANA_APPINDICATOR_INCLUDE_DIR AND AYATANA_APPINDICATOR_LIBRARY))
     set(APPINDICATOR_INCLUDE_DIR ${AYATANA_APPINDICATOR_INCLUDE_DIR})
     set(APPINDICATOR_LIBRARY ${AYATANA_APPINDICATOR_LIBRARY})
     set(APPINDICATOR_IS_AYATANA ON)
diff --git a/gtk/transmission-gtk.desktop.in b/gtk/transmission-gtk.desktop.in
index 8d568a8..6a3ccd6 100644
--- a/gtk/transmission-gtk.desktop.in
+++ b/gtk/transmission-gtk.desktop.in
@@ -4,7 +4,7 @@ GenericName=BitTorrent Client
 Comment=Download and share files over BitTorrent
 # Translators: Search terms to find this application. Do NOT translate or localize the semicolons! The list MUST also end with a semicolon!
 Keywords=torrents;downloading;uploading;share;sharing;
-Exec=transmission-gtk %U
+Exec=env UBUNTU_MENUPROXY=0 transmission-gtk %U
 Icon=transmission
 Terminal=false
 TryExec=transmission-gtk
@@ -18,8 +18,8 @@ Actions=Pause;Minimize;
 
 [Desktop Action Pause]
 Name=Start Transmission with All Torrents Paused
-Exec=transmission-gtk --paused
+Exec=env UBUNTU_MENUPROXY=0 transmission-gtk --paused
 
 [Desktop Action Minimize]
 Name=Start Transmission Minimized
-Exec=transmission-gtk --minimized
+Exec=env UBUNTU_MENUPROXY=0 transmission-gtk --minimized
-- 
2.49.1

