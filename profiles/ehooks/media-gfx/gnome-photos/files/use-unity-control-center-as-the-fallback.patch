From bdfd62eba92c2e794dde14114f6c92007c9d4137 Mon Sep 17 00:00:00 2001
From: c4pp4
Date: Fri, 1 Oct 2021 02:21:26 +0200
Subject: [PATCH 1/1] Use unity-control-center as the fallback

Try to use unity-control-center as the fallback when gnome-control-center
is not available.

Signed-off-by: c4pp4
---
 src/photos-utils.c | 45 ++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 44 insertions(+), 1 deletion(-)

diff --git a/src/photos-utils.c b/src/photos-utils.c
index 5cfddaa..ca4b63c 100644
--- a/src/photos-utils.c
+++ b/src/photos-utils.c
@@ -1141,6 +1141,47 @@ photos_utils_is_flatpak (void)
   return ret_val;
 }
 
+static gboolean
+in_desktop (const gchar *name)
+{
+  const gchar *desktop_name_list;
+  gchar **names;
+  gboolean in_list = FALSE;
+  gint i;
+
+  desktop_name_list = g_getenv ("XDG_CURRENT_DESKTOP");
+  if (!desktop_name_list)
+    return FALSE;
+
+  names = g_strsplit (desktop_name_list, ":", -1);
+  for (i = 0; names[i] && !in_list; i++)
+    if (strcmp (names[i], name) == 0) {
+      in_list = TRUE;
+      break;
+    }
+  g_strfreev (names);
+
+  return in_list;
+}
+
+static void
+photos_utils_launch_uoa (const gchar *account_id)
+{
+  const gchar* const command[] = { "unity-control-center",
+                                   "online-accounts",
+                                   account_id, NULL };
+  GError *error = NULL;
+
+  g_spawn_async (NULL, (gchar**) command,
+                 NULL,
+                 G_SPAWN_SEARCH_PATH | G_SPAWN_STDOUT_TO_DEV_NULL,
+                 NULL, NULL, NULL, &error);
+
+  if (error) {
+    g_warning ("Couldn't open Unity Control Center: %s", error->message);
+    g_error_free (error);
+  }
+}
 
 void
 photos_utils_launch_online_accounts (const gchar *account_id)
@@ -1165,8 +1206,10 @@ photos_utils_launch_online_accounts (const gchar *account_id)
 
   parameters = g_variant_new ("(s@av)", "online-accounts", g_variant_builder_end (&panel_parameters));
   g_action_group_activate_action (G_ACTION_GROUP (control_center), "launch-panel", parameters);
-}
 
+  if (!g_action_group_get_action_enabled (G_ACTION_GROUP (control_center), "launch-panel") && in_desktop ("Unity"))
+    photos_utils_launch_uoa (account_id);
+}
 
 void
 photos_utils_list_box_header_func (GtkListBoxRow *row, GtkListBoxRow *before, gpointer user_data)
-- 
2.32.0

